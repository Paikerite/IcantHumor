@page "/OAuthRedirectSuccessDiscord"
@using Microsoft.AspNetCore.WebUtilities

<PageTitle>Success Registration</PageTitle>
<div class="d-flex flex-grow-1 flex-column align-center">
    @if (infouser != null)
    {
        if (IsSuccess)
        {
            <h2 role="alert">You have successfully logged into you account. Back to work...</h2>
        }
        else
        {
            <h2 role="alert">Something gone wrong, see below..</h2>
        }
    }
    else
    {
        <h2 role="alert">Waiting response from Discord</h2>
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
    }
</div>

@code {
    [Inject]
    private NavigationManager navigationManager { get; set; } = default!;

    [Inject]
    private ISnackbar Snackbar { get; set; } = default!;

    [Inject]
    private IDiscordAPIService discordAPIService { get; set; } = default!;

    [Inject]
    private IUsersService usersService { get; set; } = default!;

    [Inject]
    private AuthenticationStateProvider authenticationStateProvider { get; set; } = default!;

    [Inject]
    private ProtectedLocalStorage LocalStorage { get; set; } = default!;

    [Inject]
    private ILogger<OAuthRedirectSuccessDiscord> logger { get; set; } = default!;

    public UserInfoDiscordAPI infouser { get; set; } = default!;

    public bool IsSuccess { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var uri = navigationManager.ToAbsoluteUri(navigationManager.Uri);

        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("code", out var authorizationCode))
        {
            try
            {
                if (string.IsNullOrEmpty(authorizationCode)) throw new NullReferenceException("authorizationCode is broken, try login again");

                var tokenResponse = await discordAPIService.GetTokenAsync(authorizationCode) 
                    ?? throw new NullReferenceException("response token is null, try login again");

                if (tokenResponse.access_token is null)
                {
                    throw new NullReferenceException("access token is null");
                }

                infouser = await discordAPIService.GetUserInfoAsync(tokenResponse.access_token) 
                    ?? throw new NullReferenceException("infouser discord is null, try login again");

                if (!infouser.verified || string.IsNullOrEmpty(infouser.email))
                {
                    throw new Exception("Your discord account isn't verified. Confirm your discord account, then try again..");
                }

                if (await usersService.IsExistEmailUserInDB(infouser.email))
                {
                    await SingIn(infouser);
                }
                else
                {
                    await Register(infouser);
                }
            }
            catch (NullReferenceException e)
            {
                logger.LogWarning(e.Message);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Some shit happend in the server, info: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task SingIn(UserInfoDiscordAPI user)
    {
        if (user.email is null || user.email == string.Empty)
        {
            throw new NullReferenceException("user email is empty or null");
        }

        var result = await usersService.GetUserByEmail(user.email);
        if (result is not null && result.UserName is not null)
        {
            var JWTToken = GenerationTokenJWT.GenerateToken(new SessionUserModel
                {
                    Id = result.Id,
                    Role = result.Role,
                    UserName = result.UserName,
                });

            await LocalStorage.SetAsync("ICANTHUMOR512", JWTToken);
            await authenticationStateProvider.GetAuthenticationStateAsync();
            IsSuccess = true;
            navigationManager.NavigateTo("/", true);
        }
    }

    private async Task Register(UserInfoDiscordAPI user)
    {
        try
        {
            UserViewModel userViewModel = new()
                {
                    Role = Models.Enums.Roles.User,
                    UserName = user.username,
                    ProfilePicture = GetAvatarUrl(user),
                    FullUserInfo = new()
                    {
                        UserEmail = user.email,
                        ConfirmEmail = user.verified,
                        RegisteredAt = DateTime.Now,
                        Password = null,
                    }
                };

            var result = await usersService.PostUser(userViewModel);
            if (result is not null && result.UserName is not null)
            {
                var JWTToken = GenerationTokenJWT.GenerateToken(new SessionUserModel
                    {
                        Id = result.Id,
                        Role = result.Role,
                        UserName = result.UserName,
                    });

                await LocalStorage.SetAsync("ICANTHUMOR512", JWTToken);
                await authenticationStateProvider.GetAuthenticationStateAsync();
                IsSuccess = true;
                navigationManager.NavigateTo("/", true);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Some shit happend in the server, info: {ex.Message}", Severity.Error);
        }
    }

    public string? GetAvatarUrl(UserInfoDiscordAPI user)
    {
        if (string.IsNullOrEmpty(user.avatar) && !string.IsNullOrEmpty(user.discriminator))
        {
            return $"https://cdn.discordapp.com/embed/avatars/{int.Parse(user.discriminator) % 5}.png";
        }
        else if (!string.IsNullOrEmpty(user.avatar) && user.avatar.StartsWith("a_"))
        {
            return default;
        }
        else
        {
            return $"https://cdn.discordapp.com/avatars/{user.id}/{user.avatar}.png";
        }
    }
}
